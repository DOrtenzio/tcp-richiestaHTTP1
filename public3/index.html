<!doctype html>
<html lang="it">
    <head>
        <title>Api Utente</title>
        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />

        <!-- Bootstrap CSS v5.2.1 -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
        />
        <link rel="icon" type="image/x-icon" href="favicon.ico" />
    </head>

    <body>
        <main>
            <div class="d-block bg-primary text-white p-3">
                <h1 class="text-center">Richiesta HTTP con Fetch API JavaScript</h1>
            </div>
            <div class="container" >
                <div id="div-header-botton" class="d-flex flex-column my-3 justify-content-center align-items-center">
                    <h1 class="text-center my-3">Elenco Utenti</h1>
                    <div id="barra-pulsanti" class="p-3">
                        <button class="btn btn-success mx-3" onclick="vista_aggiunta()">Aggiungi Utente</button>
                    </div>
                </div>
                <form id="vista_aggiunta" class="flex-column my-3" name="input" style="display: none;">
                    <label for="name" class="form-label me-2">Nome Utente:</label>
                    <input class="" type="text" placeholder="Inserisci il nome dell'utente" name="name">
                    <br>
                    <br>
                    <label for="name" class="form-label me-2">Età Utente:</label>
                    <input class="" type="text" placeholder="Inserisci l'età dell'utente" name="eta">
                    <br>
                    <br>
                    <button class="btn btn-primary m-5" type="button" onclick="()=>{
                        const form = document.getElementById('vista_aggiunta');
                        const nomeinput=document.createElement('input');
                        input.type = 'text';
                        input.placeholder = 'Inserisci il nome del campo aggiuntivo';
                        input.name = `campo-aggiuntivo`;
                        input.className = 'valore-aggiuntivo';
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.placeholder = 'Inserisci il valore del campo aggiuntivo';
                        input.name = `campo-aggiuntivo`;
                        input.className = 'valore-aggiuntivo';
                        form.appendChild(nomeinput);
                        form.appendChild(input);
                        form.appendChild(document.createElement('br'));
                        form.appendChild(document.createElement('br'));
                    }">Aggiungi Altri Campi</button>
                    <button class="btn btn-primary m-5" type="button" onclick="aggiungi()">Inserisci</button>
                </form>
                <div class="row" id="contenitore" >
                   
                </div>
               

            </div>
            <template id="template">
                <div class="card shadow m-5 pt-2" style="width: 18rem;">
                    <img src="https://picsum.photos/200/100?random=" class="card-img-top" alt="Immagine casuale" />
                    <div class="card-body">
                        <h5 class="card-title"></h5>
                        <h6 class="card-subtitle mb-2 text-body-secondary"></h6>
                        <p class="card-text"></p>
                        <p class="card-text-2"></p>
                    </div>
                    <div class="card-footer text-body-secondary">
                    </div>
                </div>
            </template>

            <template id="template-form">
                <form id="form-modifica" class="flex-column my-3" name="input-modifica">
                    <label class="form-label me-2">Nome Utente:</label>
                    <input class="template-name" type="text" placeholder="Inserisci il nome dell'utente" name="name-modifica">
                    <br>
                    <br>
                    <label class="form-label me-2">Età Utente:</label>
                    <input class="template-eta" type="text" placeholder="Inserisci l'età dell'utente" name="eta-modifica">
                    <button id="button-form" class="btn btn-primary m-5" type="button" ">Modifica</button>
                </form>
            </template>

        </main>


        <!-- Bootstrap JavaScript Libraries -->
        <script
            src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"
        ></script>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
            integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
            crossorigin="anonymous"
        ></script>

        <script>
            function vista_aggiunta(){
                const form = document.getElementById("vista_aggiunta");
                form.style.display = form.style.display === "none" ? "flex" : "none";
            }
            function aggiungi(){
                let nome=input.name.value;
                let eta=input.eta.value;
                if(nome && eta){
                    let datiAggiuntivi={};
                    for(let i=0;i<document.getElementsByClassName('valore-aggiuntivo').length;i+=2){
                        let chiave=document.getElementsByClassName('valore-aggiuntivo')[i].value;
                        let valore=document.getElementsByClassName('valore-aggiuntivo')[i+1].value;
                        datiAggiuntivi[chiave]=valore;
                    }

                    fetch('https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users', {
                        method: 'POST',
                        headers: {
                            'accept': '*/*',
                            'Authorization': 'Bearer 5IDtoken',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            'name': nome,
                            'age': eta,
                            datiAggiuntivi
                        })
                    })
                    .then(response=>{
                        if(!response.ok) throw new Error("Errore nella risposta");
                        //salvo location passata utente
                        salvaLocazione(response.headers.get('location'));
                        return response.json();
                    }).catch(error=>console.error('Errore:', error));
                } else {
                    alert("Nome ed età sono obbligatori");
                }
            }

            function salvaLocazione(location){
                if(sessionStorage.getItem('locations')){
                    let locations=JSON.parse(sessionStorage.getItem('locations'));
                    locations.push(location);
                    sessionStorage.setItem('locations',JSON.stringify(locations));
                } else {
                    let locations=[location];
                    sessionStorage.setItem('locations',JSON.stringify(locations));
                }
            }

            function ottieniLocazioni(){
                if(sessionStorage.getItem('locations')){
                    return JSON.parse(sessionStorage.getItem('locations'));
                } else {
                    return [];
                }
            }
        </script>

        <script>
            fetch('https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users', {
                headers: { 'accept': '*/*' }
            })
            .then(response => {
                if (!response.ok) throw new Error("Errore nella risposta");
                return response.json();
            })
            .then(data => {
                data.forEach(user => {
                    if(ottieniLocazioni().length>0){
                        setInterval(() => {
                            const locazioni=ottieniLocazioni();
                            for(const locazione of locazioni){
                                let utenteDaAggiungere=locazione.split('/').pop();
                                const carta=document.querySelector(`[data-user="${utenteDaAggiungere}"]`);
                                fetch(`https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users/${nomeutente}`, {
                                    headers: { 'accept': '*/*' }
                                })
                                .then(response => {
                                    if (!response.ok) throw new Error("Errore nella risposta");
                                    return response.json();
                                })
                                .then(data => {
                                    const contenitore = document.querySelector(`.card[data-user="${data.name}"]`);
                                    contenitore.querySelector(".card-subtitle").textContent = user.role ? `Ruolo: ${user.role}` : "Ruolo: Non Presente";
                                    contenitore.querySelector(".card-text").textContent = `Età: ${user.age}`;

                                    contenitore.classList.add('border-warning');
                                })
                                .catch(error => console.error('Errore:', error));

                            }
                        }, 2000);
                    } else{
                        const fragment = document.getElementById("template").content.cloneNode(true);
                        const cloneCard = fragment.querySelector('.card'); 

                        cloneCard.querySelector(".card-title").textContent = user.name;
                        cloneCard.dataset.user = user.name;

                        cloneCard.querySelector(".card-subtitle").textContent = user.role ? `Ruolo: ${user.role}` : "Ruolo: Non Presente";
                        cloneCard.querySelector(".card-text").textContent = `Età: ${user.age}`;

                        if (Object.keys(data).length>2) {
                            for(const attributo of Object.keys(data)){
                                if(attributo!=="name" && attributo!=="age" && attributo!=="role"){
                                    let testo = "";
                                    for (const [chiave, valore] of Object.entries(data[attributo])) {
                                        testo += `<p>${chiave}:</p> ${valore}<br>`;
                                    }
                                    cloneCard.querySelector(".card-text-2").innerHTML = testo;
                                }
                            }
                        }

                        const btnElimina = document.createElement("button");
                        btnElimina.className = "btn btn-danger me-2";
                        btnElimina.textContent = "Elimina Utente";
                        btnElimina.onclick = () => eliminautente(user.name);
                        cloneCard.querySelector(".card-footer").appendChild(btnElimina);

                        const btnModifica = document.createElement("button");
                        btnModifica.className = "btn btn-secondary me-2";
                        btnModifica.textContent = "Modifica Utente";
                        btnModifica.onclick = () => modificautente(user,cloneCard);
                        cloneCard.querySelector(".card-footer").appendChild(btnModifica);

                        const btnDettagli = document.createElement("button");
                        btnDettagli.className = "btn btn-info";
                        btnDettagli.textContent = "Dettagli Utente";
                        btnDettagli.onclick = () => dettagliutente(user.name);
                        cloneCard.querySelector(".card-footer").appendChild(btnDettagli);

                        document.getElementById("contenitore").appendChild(fragment);
                    }
                });
            })
            .catch(error => console.error('Errore:', error));

            function dettagliutente(nomeutente) {
                fetch(`https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users/${nomeutente}`, {
                    headers: { 'accept': '*/*' }
                })
                .then(response => {
                    if (!response.ok) throw new Error("Errore nella risposta");
                    return response.json();
                })
                .then(data => {
                    const contenitore = document.querySelector(`.card[data-user="${data.name}"]`);
                    contenitore.querySelector(".card-subtitle").textContent = user.role ? `Ruolo: ${user.role}` : "Ruolo: Non Presente";
                    contenitore.querySelector(".card-text").textContent = `Età: ${user.age}`;

                    if (Object.keys(data).length>2) {
                        for(const attributo of Object.keys(data)){
                            if(attributo!=="name" && attributo!=="age" && attributo!=="role"){
                                let testo = "";
                                for (const [chiave, valore] of Object.entries(data[attributo])) {
                                    testo += `<p>${chiave}:</p> ${valore}<br>`;
                                }
                                contenitore.querySelector(".card-text-2").innerHTML = testo;
                            }
                        }
                    }

                    const btnDettagli = contenitore.querySelector(".btn.btn-info");
                    if (btnDettagli) btnDettagli.disabled = true;
                })
                .catch(error => console.error('Errore:', error));
            }

            function eliminautente(nomeutente) {
                fetch(`https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users/${nomeutente}`, {
                    method: 'DELETE',
                    headers: { 'accept': '*/*', 'Authorization': 'Bearer 5IDtoken' }
                })
                .then(response => {
                    if (!response.ok) {
                        alert("Errore nell'eliminazione dell'utente");
                        throw new Error("Errore nella risposta");
                    }
                    const contenitore = document.querySelector(`.card[data-user="${nomeutente}"]`);
                    if (contenitore) contenitore.remove();
                })
                .catch(error => console.error('Errore:', error));
            }

            function modificautente(utente, contenitore) {
                const templateform = document.getElementById("template-form").content.cloneNode(true);
                const form = templateform.querySelector('form');

                form.querySelector(".template-name").value = utente.name;
                form.querySelector(".template-eta").value = utente.age;

                if(Object.keys(utente).length>2){
                    for(const attributo of Object.keys(utente)){
                        if(attributo!=="name" && attributo!=="age" && attributo!=="role"){
                            for (const [chiave, valore] of Object.entries(utente[attributo])) {
                                const labelData = document.createElement("label");
                                labelData.className = "form-label me-2";
                                labelData.textContent = `${chiave}:`;
                                form.appendChild(labelData);
                                const inputData = document.createElement("input");
                                inputData.type = "text";
                                inputData.value = valore;
                                inputData.name = `data-${chiave}-modifica`;
                                form.appendChild(inputData);
                            }
                        } else if(attributo==="role"){
                            const labelRole = document.createElement("label");
                            labelRole.className = "form-label me-2";
                            labelRole.textContent = "Ruolo Utente:";
                            form.appendChild(labelRole);
                            const inputRole = document.createElement("input");
                            inputRole.type = "text";
                            inputRole.value = utente.role;
                            inputRole.name = "role-modifica";
                            form.appendChild(inputRole);
                        }
                    }
                }

                contenitore.appendChild(templateform);

                const formApp = contenitore.querySelector('#form-modifica');
                const btnModificaForm = formApp.querySelector('#button-form');
                btnModificaForm.onclick = (utente) => {
                    const bodyuno={};

                    const nameVal = formApp.querySelector('.template-name').value.trim();
                    const ageVal = formApp.querySelector('.template-eta').value;

                    bodyuno.name=nameVal;
                    bodyuno.age=ageVal;

                    if(Object.keys(utente).length>2){
                        for(const attributo of Object.keys(utente)){
                            if(attributo!=="name" && attributo!=="age" && attributo!=="role"){
                                for (const [chiave, valore] of Object.entries(utente[attributo])) {
                                    const dataObj = {};
                                    const dataVal = formApp.querySelector(`input[name="data-${chiave}-modifica"]`).value.trim();
                                    dataObj[chiave] = dataVal;
                                    bodyuno.data = dataObj;
                                }
                            } else if(attributo==="role"){
                                const roleVal = formApp.querySelector('input[name="role-modifica"]').value.trim();
                                bodyuno.role=roleVal;
                            }
                        }
                    }

                    fetch(`https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users/${utente.name}`, {
                        method: 'PUT',
                        headers: {
                            'accept': '*/*',
                            'Authorization': 'Bearer 5IDtoken',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(bodyuno)
                    })
                    .then(resp => {
                        if (!resp.ok) throw new Error('Errore nella modifica');
                        salvaLocazione(resp.headers.get('location'));
                        return resp.json();
                    })
                    .then(()=> location.reload())
                    .catch(err => console.error(err));
                };
            }
        </script>
    </body>
</html>