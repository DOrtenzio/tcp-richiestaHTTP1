<!doctype html>
<html lang="it">
    <head>
        <title>Api Utente</title>
        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />

        <!-- Bootstrap CSS v5.2.1 -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
        />
        <link rel="icon" type="image/x-icon" href="favicon.ico" />
    </head>

    <body>
        <main>
            <div class="d-block bg-primary text-white p-3">
                <h1 class="text-center">Richiesta HTTP con Fetch API JavaScript</h1>
            </div>
            <div class="container" >
                <div id="div-header-botton" class="d-flex flex-column my-3 justify-content-center align-items-center">
                    <h1 class="text-center my-3">Elenco Utenti</h1>
                    <div id="barra-pulsanti" class="p-3">
                        <button class="btn btn-success mx-3" onclick="vista_aggiunta()">Aggiungi Utente</button>
                        <script>
                            function vista_aggiunta(){
                                const form = document.getElementById("vista_aggiunta");
                                form.style.display = form.style.display === "none" ? "flex" : "none";
                            }
                        </script>
                    </div>
                </div>
                <form id="vista_aggiunta" class="flex-column my-3" name="input" style="display: none;">
                    <div class="input_spazio_aggiunta d-flex flex-column">
                        <div class="d-flex align-items-center gap-2">
                            <label class="form-label me-2">Nome Utente:</label>
                            <input class="" type="text" placeholder="Inserisci il nome dell'utente" name="name" required>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <label class="form-label me-2">Età Utente:</label>
                            <input class="" type="text" placeholder="Inserisci l'età dell'utente" name="eta" required>
                        </div>
                    </div>
                    
                    
                    <div class="inline-block d-flex justify-content-center">
                        <button class="btn btn-primary m-5" type="button" onclick="aggiungiCampo()">Aggiungi Altri Campi</button>
                        <script>
                            function aggiungiCampo(){
                                const div_input = document.getElementById('vista_aggiunta').querySelector('.input_spazio_aggiunta');
                                const div_interno=document.createElement('div');
                                div_interno.className='d-flex align-items-center gap-2';

                                const nomeinput=document.createElement('input');
                                nomeinput.type = 'text';
                                nomeinput.placeholder = 'Inserisci il nome del campo aggiuntivo';
                                nomeinput.name = `campo-aggiuntivo`;
                                nomeinput.className = 'valore-aggiuntivo';
                                nomeinput.required=true;
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.placeholder = 'Inserisci il valore del campo aggiuntivo';
                                input.name = `campo-aggiuntivo`;
                                input.required=true;
                                input.className = 'valore-aggiuntivo';
                                const buttonRimuovi=document.createElement('button');
                                buttonRimuovi.type='button';
                                buttonRimuovi.className='btn btn-danger';
                                buttonRimuovi.textContent='X';
                                buttonRimuovi.onclick=()=>{
                                    div_interno.remove(input, nomeinput, buttonRimuovi);
                                };
                                div_interno.appendChild(nomeinput);
                                div_interno.appendChild(input);
                                div_interno.appendChild(buttonRimuovi);

                                div_input.appendChild(div_interno);
                            }                        
                            </script>
                        <button class="btn btn-primary m-5" type="button" onclick="aggiungi()">Inserisci</button>
                        <script>
                            function aggiungi(){
                                let nome=input.name.value;
                                let eta=input.eta.value;
                                let body={
                                    'name': nome,
                                    'age': eta
                                };
                                if(nome && eta){
                                    if(document.getElementsByClassName('valore-aggiuntivo').length>0){
                                        for(let i=0;i<document.getElementsByClassName('valore-aggiuntivo').length;i+=2){
                                            let chiave=document.getElementsByClassName('valore-aggiuntivo')[i].value;
                                            let valore=document.getElementsByClassName('valore-aggiuntivo')[i+1].value;
                                            body[chiave]=valore;
                                        }
                                    }
                                    
                                    fetch('https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users', {
                                        method: 'POST',
                                        headers: {
                                            'accept': '*/*',
                                            'Authorization': 'Bearer 5IDtoken',
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify(body)
                                    })
                                    .then(response=>{
                                        if(!response.ok) throw new Error("Errore nella risposta");
                                        //salvaLocazione(response.headers.get('location'));
                                        vista_aggiunta();
                                        return response.json();
                                    }).catch(error=>console.error('Errore:', error));
                                }
                            }
                        </script>
                    </div>
                </form>
                <div class="row" id="contenitore" >
                   
                </div>
               

            </div>

            <template id="template">
                <div class="card shadow m-5 pt-2" style="width: 18rem;">
                    <img src="https://picsum.photos/200/100?random=" class="card-img-top" alt="Immagine casuale" />
                    <div class="card-body">
                        <h5 class="card-title"></h5>
                        <h6 class="card-subtitle mb-2 text-body-secondary"></h6>
                        <p class="card-text"></p>
                        <p class="card-text-2"></p>
                    </div>
                    <div class="card-footer text-body-secondary">
                    </div>
                </div>
            </template>

            <template id="template-form">
                <form class="flex-column my-3" name="input-modifica">
                    <div class="spazio_input d-flex flex-column">
                        <label class="form-label me-2">Nome Utente:</label>
                        <input class="template-name" type="text" placeholder="Inserisci il nome dell'utente" name="name-modifica" required>
                        <label class="form-label me-2">Età Utente:</label>
                        <input class="template-eta" type="text" placeholder="Inserisci l'età dell'utente" name="eta-modifica" required>
                    </div>
                    <div class="bottoni_spazio mt-3 inline-block d-flex justify-content-center">
                        <button class="button-form btn btn-primary m-5" type="button">Modifica</button>
                    </div>
                </form>
            </template>

        </main>


        <!-- Bootstrap JavaScript Libraries -->
        <script
            src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"
        ></script>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
            integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
            crossorigin="anonymous"
        ></script>

        <script>
            fetch('https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users', {
                headers: { 'accept': '*/*' }
            })
            .then(response => {
                if (!response.ok) throw new Error("Errore nella risposta");
                return response.json();
            })
            .then(data => {
                if(ottieniConf().length===0) salvaConf(data);

                data.forEach(user => {
                    const templ = document.getElementById("template").content.cloneNode(true);
                    const cloneCard = templ.querySelector('.card'); 

                    cloneCard.querySelector(".card-title").textContent = user.name;
                    cloneCard.dataset.user = user.name;

                    cloneCard.querySelector(".card-subtitle").textContent = user.role ? `Ruolo: ${user.role}` : "Ruolo: Non Presente";
                    cloneCard.querySelector(".card-text").textContent = `Età: ${user.age}`;

                    const btnElimina = document.createElement("button");
                    btnElimina.className = "btn btn-danger me-2";
                    btnElimina.textContent = "Elimina Utente";
                    btnElimina.onclick = () => eliminautente(user.name);
                    cloneCard.querySelector(".card-footer").appendChild(btnElimina);

                    const btnModifica = document.createElement("button");
                    btnModifica.className = "btn btn-secondary me-2";
                    btnModifica.textContent = "Modifica Utente";
                    btnModifica.onclick = () => modificautente(user,cloneCard);
                    cloneCard.querySelector(".card-footer").appendChild(btnModifica);

                    const btnDettagli = document.createElement("button");
                    btnDettagli.className = "btn btn-info";
                    btnDettagli.textContent = "Dettagli Utente";
                    btnDettagli.onclick = () => dettagliutente(user.name);
                    cloneCard.querySelector(".card-footer").appendChild(btnDettagli);

                    document.getElementById("contenitore").appendChild(templ);
                });
            })
            .catch(error => console.error('Errore:', error));

            setInterval(() => {
                fetch('https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users', {
                    headers: { 'accept': '*/*' }
                })
                .then(response => {
                    if (!response.ok) throw new Error("Errore nella risposta");
                    return response.json();
                }) .then(nuoviDati => {
                    const modificati = ottieniModifiche(nuoviDati);
                    if(modificati.length===0) return;
                    pulisciBordi();
                    for(const utenteModificato of modificati){
                        let nomeutente=utenteModificato.name;
                        const carta=document.querySelector(`[data-user="${nomeutente}"]`);
                        if(!carta){
                                const temp = document.getElementById("template").content.cloneNode(true);
                                const cloneCard = temp.querySelector('.card'); 

                                cloneCard.querySelector(".card-title").textContent = utenteModificato.name;
                                cloneCard.dataset.user = utenteModificato.name;

                                cloneCard.querySelector(".card-subtitle").textContent = utenteModificato.role ? `Ruolo: ${utenteModificato.role}` : "Ruolo: Non Presente";
                                cloneCard.querySelector(".card-text").textContent = `Età: ${utenteModificato.age}`;

                                const btnElimina = document.createElement("button");
                                btnElimina.className = "btn btn-danger me-2";
                                btnElimina.textContent = "Elimina Utente";
                                btnElimina.onclick = () => eliminautente(utenteModificato.name);
                                cloneCard.querySelector(".card-footer").appendChild(btnElimina);

                                const btnModifica = document.createElement("button");
                                btnModifica.className = "btn btn-secondary me-2";
                                btnModifica.textContent = "Modifica Utente";
                                btnModifica.onclick = () => modificautente(utenteModificato,cloneCard);
                                cloneCard.querySelector(".card-footer").appendChild(btnModifica);

                                const btnDettagli = document.createElement("button");
                                btnDettagli.className = "btn btn-info";
                                btnDettagli.textContent = "Dettagli Utente";
                                btnDettagli.onclick = () => dettagliutente(utenteModificato.name);
                                cloneCard.querySelector(".card-footer").appendChild(btnDettagli);

                                document.getElementById("contenitore").appendChild(temp);
                        } else{
                            carta.querySelector(".card-subtitle").textContent = utenteModificato.role ? `Ruolo: ${utenteModificato.role}` : "Ruolo: Non Presente";
                            carta.querySelector(".card-text").textContent = `Età: ${utenteModificato.age}`;
                            carta.classList.add('border-warning');
                        } 
                    }
                    salvaConf(nuoviDati);
                }).catch(error => console.error('Errore:', error));

                /* Versione alternativa in cui aggiorno solo utenti toccati da utente stesso
                const locazioni=ottieniLocazioni();

                for(const locazione of locazioni){
                    let utenteDaAggiungere=locazione.split('/').pop();
                    const carta=document.querySelector(`[data-user="${utenteDaAggiungere}"]`);
                    fetch(`https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users/${nomeutente}`, {
                        headers: { 'accept': '* /*' } <-- messo spazio per non rompere al commento
                    })
                    .then(response => {
                        if (!response.ok) throw new Error("Errore nella risposta");
                        return response.json();
                    })
                    .then(data => {
                        const contenitore = document.querySelector(`.card[data-user="${data.name}"]`);
                        contenitore.querySelector(".card-subtitle").textContent = user.role ? `Ruolo: ${user.role}` : "Ruolo: Non Presente";
                        contenitore.querySelector(".card-text").textContent = `Età: ${user.age}`;

                        contenitore.classList.add('border-warning');
                    })
                    .catch(error => console.error('Errore:', error));

                }
                */
            }, 2000);

            /* Versione alternativa in cui aggiorno solo utenti toccati da utente stesso
            //funz per gestione semplice di sessione per salvare modificati o aggiunti
            function salvaLocazione(location){
                if(sessionStorage.getItem('locations')){
                    let locations=JSON.parse(sessionStorage.getItem('locations'));
                    locations.push(location);
                    sessionStorage.setItem('locations',JSON.stringify(locations));
                } else {
                    let locations=[location];
                    sessionStorage.setItem('locations',JSON.stringify(locations));
                }
            }
            function ottieniLocazioni(){
                if(sessionStorage.getItem('locations')){
                    return JSON.parse(sessionStorage.getItem('locations'));
                } else {
                    return [];
                }
            }
            */

            function pulisciBordi(){
                const carte=document.querySelectorAll('.card');
                carte.forEach(carta => {
                    carta.classList.remove('border-warning');
                });
            }

            //funz per salvare elementi presenti così da aggiornare solo modificati
            function salvaConf (config){
                if(sessionStorage.getItem('config')){
                    let conf=JSON.parse(sessionStorage.getItem('config'));
                    conf.push(config);
                    sessionStorage.setItem('config',JSON.stringify(conf));
                } else {
                    let conf=config;
                    sessionStorage.setItem('config',JSON.stringify(conf));
                }
            }

            function ottieniConf(){
                if(sessionStorage.getItem('config')){
                    return JSON.parse(sessionStorage.getItem('config'));
                } else {
                    return [];
                }
            }

            function ottieniModifiche(nuovaConf){
                if(sessionStorage.getItem('config')){
                    let conf=JSON.parse(sessionStorage.getItem('config'));
                    let modificati=[];
                    for(const elemento of nuovaConf){
                        const esiste = conf.some( oldEl => JSON.stringify(oldEl) === JSON.stringify(elemento));
                        if (!esiste) {
                            modificati.push(elemento);
                        }

                        /*
                        let esiste = false;
                        for (const oldEl of conf) {
                        if (JSON.stringify(oldEl) === JSON.stringify(elemento)) {
                            esiste = true;
                            break;
                        }
                        }
                        */
                    }
                    return modificati;
                } else {
                    return nuovaConf;
                }
            }

            //funz su singolo
            function dettagliutente(nomeutente) {
                fetch(`https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users/${nomeutente}`, {
                    headers: { 'accept': '*/*' }
                })
                .then(response => {
                    if (!response.ok) throw new Error("Errore nella risposta");
                    return response.json();
                })
                .then(data => {
                    const contenitore = document.querySelector(`.card[data-user="${data.name}"]`);
                    contenitore.querySelector(".card-subtitle").textContent = data.role ? `Ruolo: ${data.role}` : "Ruolo: Non Presente";
                    contenitore.querySelector(".card-text").textContent = `Età: ${data.age}`;

                    if (Object.keys(data).length>2) {
                        for(const [chiave,valore] of Object.entries(data)){
                            if(chiave!=="name" && chiave!=="age" && chiave!=="role"){
                                let testo = "";
                                testo += `<p>${chiave}: ${valore}</p>`;
                                contenitore.querySelector(".card-text-2").innerHTML = testo;
                            }
                        }
                    }

                    const btnDettagli = contenitore.querySelector(".btn.btn-info");
                    if (btnDettagli) btnDettagli.disabled = true;
                })
                .catch(error => console.error('Errore:', error));
            }
            function eliminautente(nomeutente) {
                fetch(`https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users/${nomeutente}`, {
                    method: 'DELETE',
                    headers: { 'accept': '*/*', 'Authorization': 'Bearer 5IDtoken' }
                })
                .then(response => {
                    if (!response.ok) {
                        alert("Errore nell'eliminazione dell'utente");
                        throw new Error("Errore nella risposta");
                    }
                    const contenitore = document.querySelector(`.card[data-user="${nomeutente}"]`);
                    if (contenitore) contenitore.remove();
                })
                .catch(error => console.error('Errore:', error));
            }
            function modificautente(utente, contenitore) {
                const templateform = document.getElementById("template-form").content.cloneNode(true);
                const form = templateform.querySelector('form');

                form.dataset.form_modifica=utente.name;

                const spazio_input=form.querySelector('.spazio_input');
                spazio_input.querySelector(".template-name").value = utente.name;
                spazio_input.querySelector(".template-eta").value = utente.age;

                if(Object.keys(utente).length>2){
                    for(const [chiave, valore] of Object.entries(utente)){
                        if(chiave!=="name" && chiave!=="age" && chiave!=="role"){
                            const labelData = document.createElement("label");
                            labelData.className = "form-label me-2";
                            labelData.textContent = `${chiave}:`;
                            spazio_input.appendChild(labelData);
                            const inputData = document.createElement("input");
                            inputData.type = "text";
                            inputData.value = valore;
                            inputData.required=true;
                            inputData.name = `data-${chiave}-modifica`;
                            spazio_input.appendChild(inputData);
                        } else if(chiave==="role"){
                            const labelRole = document.createElement("label");
                            labelRole.className = "form-label me-2";
                            labelRole.textContent = "Ruolo Utente:";
                            spazio_input.appendChild(labelRole);
                            const inputRole = document.createElement("input");
                            inputRole.type = "text";
                            inputRole.value = utente.role;
                            inputRole.required=true;
                            inputRole.name = "role-modifica";
                            spazio_input.appendChild(inputRole);
                        }
                    }
                }

                const button=document.createElement('button');
                button.type='button';
                button.className='btn btn-secondary m-5';
                button.textContent='Aggiungi Parametro';
                button.onclick=()=>{
                                const labelData = document.createElement("input");
                                labelData.className = "form-label me-2";
                                labelData.type="text";
                                labelData.placeholder="Inserisci il nome del campo aggiuntivo";
                                labelData.required=true;
                                labelData.name = `data-nuovo-modifica`;

                                const inputData = document.createElement("input");
                                inputData.type = "text";
                                inputData.placeholder = "Inserisci il valore del campo aggiuntivo";
                                inputData.name = `data-nuovo-modifica`;
                                inputData.required=true;

                                form.after(labelData, inputData);
                };

                const annulla=document.createElement('button');
                annulla.type='button';
                annulla.className='btn btn-secondary m-5';
                annulla.textContent='Annulla Modifica';
                annulla.onclick=()=>{
                    const formEsistente=contenitore.querySelector('[data-form_modifica="' + utente.name + '"]');
                    if(formEsistente){
                        formEsistente.remove(); 
                    }
                };

                const bottoni_spazio=form.querySelector('.bottoni_spazio');

                bottoni_spazio.appendChild(annulla);
                bottoni_spazio.appendChild(button);
                contenitore.appendChild(templateform);

                const input_form = contenitore.querySelector('[data-form_modifica="' + utente.name + '"]').querySelector('spazio_input');
                const btnModificaForm = bottoni_spazio.querySelector('.button-form');
                btnModificaForm.onclick = () => {
                    const bodyuno={};

                    const nameVal = input_form.querySelector('.template-name').value.trim();
                    const ageVal = input_form.querySelector('.template-eta').value;

                    bodyuno.name=nameVal;
                    bodyuno.age=ageVal;

                    if(Object.keys(utente).length>2){ //valori in più gia presenti
                        for(const [chiave,valore] of Object.entries(data)){
                            if(chiave!=="name" && chiave!=="age" && chiave!=="role"){
                                const dataVal = input_form.querySelector(`input[name="data-${chiave}-modifica"]`).value.trim();
                                bodyuno[chiave] = dataVal;
                            } else if(attributo==="role"){
                                const roleVal = input_form.querySelector('input[name="role-modifica"]').value.trim();
                                bodyuno.role=roleVal;
                            }
                        }
                    }

                    const nuoviCampi = input_form.querySelectorAll('.data-nuovo-modifica');
                    if(nuoviCampi.length>0 && nuoviCampi.length%2===0){
                        for(let i=0; i<nuoviCampi.length;i+=2){
                            bodyuno[nuoviCampi[i].value.trim()]=nuoviCampi[i+1].value.trim();
                        }
                    }


                    fetch(`https://friendly-space-giggle-x5r5977xv7q426wqr-3000.app.github.dev/api/users/${utente.name}`, {
                        method: 'PUT',
                        headers: {
                            'accept': '*/*',
                            'Authorization': 'Bearer 5IDtoken',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(bodyuno)
                    })
                    .then(resp => {
                        if (!resp.ok) throw new Error('Errore nella modifica');
                        //salvaLocazione(resp.headers.get('location'));
                        return resp.json();
                    })
                    .then(()=> location.reload())
                    .catch(err => console.error(err));
                };
            }
        </script>
    </body>
</html>